<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
    <title>todoList</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="static/js/jquery.js"></script>
    <script src="static/js/eMisc.js"></script> 	
</head>
<body>
    
<div >
    <form>
        <label>Id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label><input type="number" id="idInput" name="Id" min=0 /><br>
        <label>Name&nbsp;&nbsp;&nbsp;&nbsp;</label><input type="text" id="NameInput" name="Name"><br>
        <label>Datetime</label><input type="text" id="TimeInput" name="Datetime"> <!--label>Tag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label><input type="text" id="TagInput"name="Tag"><br> -->
        <label>Height&nbsp;&nbsp;</label><input type="number" value=0 id="HeightInput" name="Height" min=0 max=100 > 
        <br>
        <label>Project</label><select id="cmbProjectInput" class="form-control" name="leaguerPower" value="${requestScope.leaguer.leaguerPower }" ></select>
        <label>IsProject</label><input type="checkbox" value="checkbox" id="chkIsProject" title="texx"  >  
        <br>
        
        <label>Tag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
        <select id="TagInput" class="form-control" name="leaguerPower" value="${requestScope.leaguer.leaguerPower }" >
                    <option value="work" selected=True>work</option>
                    <option value="weekly">weekly</option>
                    <option value="study">study</option>
                    <option value="relax">relax</option>  
                    <option value="self">self</option> 
                    <option value="keyword">keyword</option> 
                    <option value="others">others</option>                         
        </select>
        <label>verb</label><select id="VerbInput" class="form-control" name="leaguerPower" value="${requestScope.leaguer.leaguerPower }" style="width:10%;height:5%"></select>
        <br>
       
        <textarea  name="Txt" id="TxtInput" placeholder="补充描述" rows = 5 cols = 26></textarea>       
    </form>

    <br>
    <input type="button" id="newTodo" value="new" style="padding-right:30px;">
    <input type="button" id="popTodo" value="pop">
    <input type="button" id="delData" value="删除">	
    <br>
    <input type="button" id="filtTime" value="filter">
    <select id="tagCombo" class="form-control" name="leaguerPower" value="${requestScope.leaguer.leaguerPower }" style="width:10%;height:5%">
            　　<option value="All" selected=True>All</option>
                <option value="work" >work</option>
                <option value="study" >study</option>  
                <option value="weekly" >weekly</option>   
                <option value="relax">relax</option>
                <option value="self">self</option> 
                <option value="keyword">keyword</option> 
                <option value="others">others</option>                                                              
    </select>
    <select id="timeCombo" class="form-control" name="leaguerPower" value="${requestScope.leaguer.leaguerPower }" style="width:10%;height:5%">
            　　<option value="All" selected=True>All</option>
                <option value="86400" >1day</option>
                <option value="604800">weekly</option>
                <option value="2593000">month</option>
                <option value="15558000">6months</option>
    </select> 
    <select id="heightCombo" class="form-control" name="leaguerPower" value="${requestScope.leaguer.leaguerPower }" style="width:10%;height:5%">
            　　<option value="All" selected=True>All</option>
                <option value="0" >Running</option>
                <option value="85" >RunOrSuspend</option>
                <option value="90" >Suspend</option>
                <option value="100" >Finished</option>
    </select>
    <input type="text" id="nameFilterInput" /><br>
    <select id="projectCombo" class="form-control" name="leaguerPower" value="${requestScope.leaguer.leaguerPower }" style="width:10%;height:5%">
            　　<option value="All" selected=True>All</option>
    </select>
    <select id="verbCombo" class="form-control" name="leaguerPower" value="${requestScope.leaguer.leaguerPower }" style="width:10%;height:5%">
            　　<option value="All" selected=True>All</option>
    </select>
    <br>
    <input type="button" id="sortBtn" value="sorts">
    <select id="sortCombo" class="form-control" name="leaguerPower" value="${requestScope.leaguer.leaguerPower }" style="width:10%;height:5%">
        　　<option value="idDescend" >idDescend</option>
            <option value="TagAscend">TagAscend</option>        
            <option value="heightAscend">heightAscend</option>
            <option value="visitRecent" selected=True>visitRecent</option>
    </select>
    <select id="reverseCombo" class="form-control" name="leaguerPower" value="${requestScope.leaguer.leaguerPower }" style="width:10%;height:5%">     
            <option value="default" selected=True>default</option>
            <option value="reverse">reverse</option>
    </select>
    

</select> 
    <br>
    <input type="button" id="getData" value="获取" style="padding-right:30px;">	
    <input type="button" id="submit" value="提交" style="padding-right:30px;">
    
    <input type="button" id="history" value="历史" style="padding-right:30px;">
    <br>

</div>
    <h3>任务表格</h3>  
    <table width="800" border="0" cellpadding="0" cellspacing="0" id="tabProduct">  
        <tr>  
            <td width="32" align="center" bgColor="#EFEFEF" Name="Id"><input type="checkbox" name="checkbox" value="checkbox" /></td>  
            <td width="40" bgColor="#EFEFEF" Name="Id" EditType="TextBox">序号</td>  
            <td width="80" bgColor="#EFEFEF" Name="Name" EditType="TextBox"  >名称</td>  
            <td width="80" bgColor="#EFEFEF" Name="Tag"  EditType="DropDownList" DataItems="{text:'work',value:'work'},{text:'study',value:'study'},{text:'weekly',value:'weekly'},{text:'relax',value:'relax'}">标签</td>  
            <td width="100" bgColor="#EFEFEF" Name="Datetime" EditType="TextBox">日期</td>  
            <td width="50" bgColor="#EFEFEF" Name="Height" EditType="TextBox">进度</td>  
            <td width="150" bgColor="#EFEFEF" Name="Txt" EditType="TextBox">文本</td>   
            <td width="150" bgColor="#EFEFEF" Name="button" EditType="TextBox">进度</td>             
            <!-- <td width="120" bgcolor="#EFEFEF" Name="Height" Expression="Amount*Price" Format="#,###.00">进度</td>   -->
            

        </tr>  
        <tr>  
            <td align="center" bgColor="#FFFFFF"><input type="checkbox" name="checkbox2" value="checkbox" /></td>  
            <td bgColor="#FFFFFF">1</td>  
            <td bgColor="#FFFFFF" >0</td>  
            <td bgColor="#FFFFFF" Value="weekly">0</td>  
            <td bgColor="#FFFFFF">0</td>  
            <td bgColor="#FFFFFF">0</td>  
            <td bgColor="#FFFFFF">0</td>  
            <td bgColor="#FFFFFF">0</td>           
        </tr>  
    </table> 
<!--       <textarea id=txt2 cols=45>ta</textarea>
      <input type="button" id="editData" value="更改">	
     <script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.11.3.min.js"></script>-->

<script>
    var gDat;
    tagList=["work","study","weekly","random"];
    var idMax = 0;
    function formatDate(time){
        var date = new Date(time);

        var year = date.getFullYear(),
            month = date.getMonth()+1,//月份是从0开始的
            day = date.getDate(),
            hour = date.getHours(),
            min = date.getMinutes(),
            sec = date.getSeconds();
        var newTime = year + '-' +
                    (month < 10? '0' + month : month) + '-' +
                    (day < 10? '0' + day : day) + ' ' +
                    (hour < 10? '0' + hour : hour) + ':' +
                    (min < 10? '0' + min : min) + ':' +
                    (sec < 10? '0' + sec : sec);

        return newTime;         
    }



    function clearInput(){
        document.getElementById('idInput').value= 0;
        document.getElementById('NameInput').value= '';       
        document.getElementById('TimeInput').value='';
        //document.getElementById('TagInput').value= '';
        $("#TagInput").val('')  
        document.getElementById('HeightInput').value= 0; 
        document.getElementById('TxtInput').value= ""; 
        
    }
    $('input[id=newTodo]').click(function (){
        console.log("new")   
        dt = {"Id":idMax,"Name":"","Datetime":formatDate(new Date().getTime()),"Tag":"work",
            "Height":0,"Txt":"","IsProject":false,"ParentProject":0};
        popTodoToLinebox(dt);
    })

    function idToIndex(id){
        for (var i=0;i<gDat.length;i++){
            if (gDat[i].Id == id){
                return i;
            }
        }
    }
    $('input[id=popTodo]').click(function (){
        var id = parseInt(document.getElementById('idInput').value)
        if ( id >0) {            
            idx =idToIndex (id);
            popIdToLinebox(idx);
        }else{
            alert("pop error")
            return ;
        }
    })
    function cmpId(a,b){
        return a.Id- b.Id
    }
    function cmpDate(a,b){
        return Date(a.Datetime) - Date(b.Datetime)
    }
    function cmpHeight(a,b){
        return a.Height- b.Height
    }
    function cmpTag(a,b){
        // const tagArr="workstudyselfweekly"
        return a.Tag.localeCompare(b.Tag)
    }
    function sortedDat(datFlt){
        if ( $("#sortCombo").val()  =="idDescend"){
            datFltSt = datFlt.sort(cmpId);
        }else if ( $("#sortCombo").val()  =="heightAscend"){
            datFltSt = datFlt.sort(cmpHeight);
        }else if ( $("#sortCombo").val()  =="TagAscend"){
            datFltSt = datFlt.sort(cmpTag);
        }else{
            datFltSt = datFlt;
        }
        if ( $("#reverseCombo").val()  =="reverse" ){
            return datFltSt.reverse();
        };
        return datFltSt
    }
    $('input[id=sortBtn]').click(function (){
        console.log("sort")
        var datFlt=filtDat(gDat);
        var datFltSt = sortedDat(datFlt)
        console.log("sort==",datFltSt) 
        tableDisp(datFltSt);
    })
    function showJson(data){
        //var a = JSON.parse(data);
        var gDat = JSON.stringify(data);
        console.log(gDat)
        //document.getElementById("txt2").innerText= str_pretty1 ;
       // document.getElementById("txt2").rows= data.length ;
    }

	$('input[id=getData]').click(function (){
        getJson('/course')
    })
/*  	get请求    */
    function getJson(url) {
		$.ajax({
			url:url,
			type:'get',
			dataType:'json',
			success:function (data) {
                gDat = data   
                for(var i=0;i<data.length;i++){
                    idMax= Math.max( parseInt(data[i].Id) +1 ,idMax );            
                }  
                tableDisp(sortedDat(filtDat(gDat)) ) 
			},
			error:function () {
				console.log("get "+url+" error");
			}
		})
    }
    
	$('input[id=history]').click(function (){
        console.log("get history  begin");
        getJson('/history')
    })

    // post请求
    $('input[id=submit]').click(function () {
        var dt = tableCollect()
        if (dt.Name=='' || dt.Id== 0){
            alert('input none');
            return;
        }
        console.log('dt=', dt,idMax)
        if (dt.Id==idMax){
            postData(dt);
        }else{
            putData(dt);
        }        
    })
    // post to delete请求
    $('input[id=delData]').click(function () {
        $.ajax({
            url: "/delete",
            type: 'post',
            data: {
                name: $('input[type=text]').val()
            },
            success: function (data) {
                console.log(data);                
            }
        })
    })

    function checkTag(xx) {
        return xx.Tag == $("#tagCombo").val();
    }  
    function checkTime(xx) {
        var tmLst= new Date(xx.Datetime)
        var now = new Date();
        var tmDif = (now - tmLst) /1000;
        return tmDif <= parseInt( $("#timeCombo").val() );
    }  
    function checkHeightMux(xx) {
        var h = $("#heightCombo").val()
        if (h=="0"){
            return (xx.Height >= 0)&&( xx.Height<90);
        }else if(h=="100"){
            return xx.Height >=96;
        }else if(h=="90"){
            return xx.Height >=90 &&  xx.Height <96;
        }else if(h=="85"){
            return  xx.Height <96;
        }
        return true;
    }  
    function checkExistName(xx) {
        return  xx.Name.toUpperCase().indexOf(   $("#nameFilterInput").val().toUpperCase() )>-1
    } 
    
    function filtDat(data){
        var datFlt=data;
        //console.log( $("#tagCombo").val(),$("#timeCombo").val() ,$("#heightCombo").val( )  )
 
        if ( $("#tagCombo").val()  !="All"){
            datFlt =datFlt.filter(checkTag);
        }
        if ( $("#timeCombo").val()  !="All"){
            datFlt =datFlt.filter(checkTime);
        }
        if ( $("#heightCombo").val()  !="All"){
            datFlt =datFlt.filter(checkHeightMux);
        }
        if ( $("#nameFilterInput").val()  !=""){
            datFlt =datFlt.filter(checkExistName);
        }
        if ( $("#projectCombo").val() !=0){            
            datFlt =datFlt.filter( function checkTag(xx) {
                return xx.ParentProject == $("#projectCombo").val();});
        }
        
        return datFlt
    }
    $('input[id=filtTime]').click(function () {
        var datFlt=filtDat(gDat);
        var datFltSt = sortedDat(datFlt)
        tableDisp(datFltSt);
    })
    function tag2Color(Tag){
        if (Tag=="work")
                bgColor='#FF0000';
            else if( Tag=="study")
                bgColor='#0000FF';
            else if( Tag=="weekly")
                bgColor='#00FFFF';  
            else
                bgColor='#00FF00';
            return bgColor;
    }
    
    function postData(dt){
        idMax++; 
        $.ajax({
            url: "/create",
            type: 'post',
            data: dt,
            success: function (data) {
                clearInput()
                console.log("post=",data);
                gDat.push(dt)
                tableDisp(sortedDat(filtDat(gDat)))
            },
            error:function () {
                console.log("post error");
                idMax--;
			}
        })
    }
    function putData(dt){
        $.ajax({
            url: "/create",
            type: 'post',
            data: dt,
            success: function (data) {
                clearInput()
                console.log("put=",data);
                gDat.push(dt)
                tableDisp(sortedDat(filtDat(gDat)))
            },
            error:function () {
                console.log("put error");
			}
        })
    }
    function popIdToLinebox(idx){
        dt = gDat[idx];
        console.log(dt);
        popTodoToLinebox(dt);
    }
    function popTodoToLinebox(dat){
        document.getElementById('idInput').value= dat.Id ;
        document.getElementById('NameInput').value= dat.Name ;
        document.getElementById('TimeInput').value = dat.Datetime;
        $("#TagInput").val(dat.Tag)  
        document.getElementById('HeightInput').value= parseInt(dat.Height); 
        document.getElementById('TxtInput').value = dat.Txt;        
        document.getElementById('chkIsProject').checked = dat.IsProject=="true";
        document.getElementById('cmbProjectInput').value = dat.ParentProject;
        //$('input[name=Id]').value = 5
        //$('input[id=TimeInput]').value = formatDate(new Date().getTime())
        //$('input[id=TagInput]').value = 'work'
       // $('input[id=HeightInput]').value = 0
    }
    function tableCollect(){
        return {
            Id: parseInt($('input[name=Id]').val()),
            Name: $('input[name=Name]').val(),
            Datetime: $('input[name=Datetime]').val(),
            Tag:  $("#TagInput").val(),// $('input[name=Tag]').val(),
            //tagList[$("#TagInput ").get(0).selectedIndex],
            // $("#TagInput").find("option:selected").text(),
            Height: parseInt($('input[name=Height]').val()),
            //Txt: $('input[name=Txt]').Text(),  
            Txt: document.getElementById('TxtInput').value,
            Misc: formatDate(new Date().getTime()), 
            IsProject: document.getElementById("chkIsProject").checked, 
            ParentProject:parseInt( $("#cmbProjectInput").val()),                     
        }
    }
    function updateCbxProject(data,objId){
        datFlt =data.filter( function(x){ return x.IsProject;} );        
        $(objId)[0].length=0;
        $(objId)[0].add(new Option("all",0));
        for (var i=0;i<datFlt.length;i++){        
            $(objId)[0].add(new Option(datFlt[i].Name,datFlt[i].Id));
        }        
    }
    //json数据转成显示表格
    function tableDisp(data){
        var table=document.getElementById("tabProduct");
        table.deleteTFoot();

        updateCbxProject(gDat,"#cmbProjectInput"); // 更新全局的project
        updateCbxProject(gDat,"#projectCombo");
        for(var i=table.rows.length-1;i>0;i--){
            table.deleteRow( i)
        }
        
        for(var i=0;i<data.length;i++){
            var row=table.insertRow(table.rows.length);
            var c1=row.insertCell(0);
            c1.innerHTML=data[i].Id;
            // console.log( data[i].Id ,data[i].Tag)
            // data[i].setAttribute("EditState", "true"); 
            // <td width="32" align="center" bgColor="#EFEFEF" Name="Id"><input type="checkbox" name="checkbox" value="checkbox" /></td>  
            c1.innerHTML="<input type='checkbox' class='chk' name='checkbox22' value='checkbox' id='checkbox_"+String(data[i].Id)+"'>"
            c1.align = "center" 
            var c2=row.insertCell(1);
            c2.innerHTML=data[i].Id;            
            var c3=row.insertCell(2);
            c3.innerHTML=data[i].Name;
            var c4=row.insertCell(3);
            c4.innerHTML=data[i].Tag;
            var c5=row.insertCell(4);
            c5.innerHTML=data[i].Datetime;
            var c5=row.insertCell(5);   
            c5.innerHTML=data[i].Height;
            var c6=row.insertCell(6);
            c6.innerHTML=data[i].Txt;
            var c7=row.insertCell(7);
            c7.innerHTML="";
            if ( data[i].Height<95)
                c7.innerHTML+="<input type='button' class='btn' name='abutton' value='完成' id='full_"+String(data[i].Id)+"'>";
            if ( data[i].Height<90)
                c7.innerHTML+="<input type='button' class='btn' name='suspend' value='挂起' id='drop_"+String(data[i].Id)+"'>"
            c7.align = "center"
            //row.bgColor= tag2Color( data[i].Tag   );
            row.style = "color:"+tag2Color( data[i].Tag   );
            // SetRowCanEdit(row)  
        }
        
        $('input[type=checkbox]').click(function (){
            if(this.checked==true){
                var id = parseInt( this.id.slice(9))
                console.log("id=",id)
                if ( id >0) {            
                    idx =idToIndex (id);
                    popIdToLinebox(idx);
                }
            }
        })
        $('input[class=btn]').click(function (){
            var id = parseInt( this.id.slice(5))
            console.log("id=",id)
            idx =idToIndex (id);
            dt = gDat[idx];
            if (this.name=="suspend")
                dt.Height = 90;
            else
                dt.Height = 99;
            putData(dt);

        })
    }
    
    window.onload=function(){ 
        getJson('/course')
    }
</script>

<style type="text/css">  
    
        body,div,p,ul,li,font,span,td,th{  
            font-size:10pt;  
            line-height:155%;  
        }  
        select{
            width:10%;
            height:5%;
        }
        table{  
            border-top-width: 1px;  
            border-right-width: 1px;  
            border-bottom-width: 0px;  
            border-left-width: 1px;  
            border-top-style: solid;  
            border-right-style: solid;  
            border-bottom-style: none;  
            border-left-style: solid;  
            border-top-color: #CCCCCC;  
            border-right-color: #CCCCCC;  
            border-bottom-color: #CCCCCC;  
            border-left-color: #CCCCCC;  
        }  

        td{  
            border-bottom-width: 1px;  
            border-bottom-style: solid;  
            border-bottom-color: #CCCCCC;  
        }  
        .EditCell_TextBox {  
            width: 90%;  
            border:1px solid #0099CC;  
        }  
        .EditCell_DropDownList {  
            width: 90%;  
        }  
        <!-- -->  
    </style>  
</body>
</html>