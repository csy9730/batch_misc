<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
    <title>todoList</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="static/js/jquery.js"></script>
    <script src="static/js/eMisc.js"></script> 	
</head>
<body>
    
<div >
    <form>
        <label >Id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label><input type="number" id="idInput" name="Id" min=0 /><br>
        <label>Name&nbsp;&nbsp;&nbsp;&nbsp;</label><input type="text" id="NameInput" name="Name"><br>
        <label>Datetime</label><input type="text" id="TimeInput" name="Datetime"><br>
        <label>Tag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
        <select id="TagInput" class="form-control" name="leaguerPower" value="${requestScope.leaguer.leaguerPower }" style="width:10%;height:5%">
                　　<option value="random">random</option>
                    <option value="work" selected=True>work</option>
                    <option value="weekly">weekly</option>
                    <option value="study">study</option>
        </select><br> 

        <!--label>Tag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label><input type="text" id="TagInput"name="Tag"><br> -->
        <label>Height&nbsp;&nbsp;</label><input type="number" value=0 id="HeightInput" name="Height" min=0 max=100 ><br>        
        </form>

    <br>
    <input type="button" id="newTodo" value="new" style="padding-right:30px;">
    <input type="button" id="popTodo" value="pop">
    <br>
    <input type="button" id="filtTime" value="filter">
    <input type="button" name="SubmitFilter" value="筛选" onclick="var datFlt=(gDat.filter(checkHeight)); tableDisp(datFlt);fltFlag= true;" /> 
    <input type="button" name="SubmitFilter" value="筛选work" onclick="var datFlt=(gDat.filter(checkWork)); tableDisp(datFlt);fltFlag= true;" /> 
    <select id="tagCombo" class="form-control" name="leaguerPower" value="${requestScope.leaguer.leaguerPower }" style="width:10%;height:5%">
            　　<option value="All" selected=True>All</option>
                <option value="work" >work</option>
                <option value="study" >study</option>  
                <option value="weekly" >weekly</option>   
                <option value="random">random</option>                       
    </select>
    <select id="timeCombo" class="form-control" name="leaguerPower" value="${requestScope.leaguer.leaguerPower }" style="width:10%;height:5%">
            　　<option value="All" selected=True>All</option>
                <option value="86400" >1day</option>
                <option value="604800">weekly</option>
                <option value="2593000">month</option>
                <option value="15558000">6months</option>
    </select> 
    <select id="heightCombo" class="form-control" name="leaguerPower" value="${requestScope.leaguer.leaguerPower }" style="width:10%;height:5%">
            　　<option value="All" selected=True>All</option>
                <option value="0" >Unfinished</option>
                <option value="1" >Running</option>
                <option value="99" >Finished</option>
    </select>

    <br>
    <input type="button" id="getData" value="获取" style="padding-right:30px;">	
    <input type="button" id="submit" value="提交" style="padding-right:30px;">
    <input type="button" id="delData" value="删除">	
    <br>

</div>
    <h3>可编辑的表格</h3>  
    <table width="698" border="0" cellpadding="0" cellspacing="0" id="tabProduct">  
        <tr>  
            <td width="32" align="center" bgcolor="#EFEFEF" Name="Id"><input type="checkbox" name="checkbox" value="checkbox" /></td>  
            <td width="40" bgcolor="#EFEFEF" Name="Id" EditType="TextBox">序号</td>  
            <td width="120" bgcolor="#EFEFEF" Name="Name" EditType="TextBox"  >名称</td>  
            <td width="80" bgcolor="#EFEFEF" Name="Tag"  EditType="DropDownList" DataItems="{text:'work',value:'work'},{text:'study',value:'study'},{text:'weekly',value:'weekly'},{text:'relax',value:'relax'}">标签</td>  
            <td width="80" bgcolor="#EFEFEF" Name="Datetime" EditType="TextBox">日期</td>  
            <td width="50" bgcolor="#EFEFEF" Name="Height" EditType="TextBox">进度</td>  
            <!-- <td width="120" bgcolor="#EFEFEF" Name="Height" Expression="Amount*Price" Format="#,###.00">进度</td>   -->
        </tr>  
        <tr>  
            <td align="center" bgcolor="#FFFFFF"><input type="checkbox" name="checkbox2" value="checkbox" /></td>  
            <td bgcolor="#FFFFFF">1</td>  
            <td bgcolor="#FFFFFF" >0</td>  
            <td bgcolor="#FFFFFF" Value="weekly">0</td>  
            <td bgcolor="#FFFFFF">0</td>  
            <td bgcolor="#FFFFFF">0</td>  
        </tr>  
    </table> 
<!--       <textarea id=txt2 cols=45>ta</textarea>
      <input type="button" id="editData" value="更改">	
     <script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.11.3.min.js"></script>-->

<script>
    var gDat;
    tagList=["work","study","weekly","random"];
    var idMax = 0;
    function formatDate(time){
        var date = new Date(time);

        var year = date.getFullYear(),
            month = date.getMonth()+1,//月份是从0开始的
            day = date.getDate(),
            hour = date.getHours(),
            min = date.getMinutes(),
            sec = date.getSeconds();
        var newTime = year + '-' +
                    (month < 10? '0' + month : month) + '-' +
                    (day < 10? '0' + day : day) + ' ' +
                    (hour < 10? '0' + hour : hour) + ':' +
                    (min < 10? '0' + min : min) + ':' +
                    (sec < 10? '0' + sec : sec);

        return newTime;         
    }
    function clearInput(){
        document.getElementById('idInput').value= 0;
        document.getElementById('NameInput').value= '';       
        document.getElementById('TimeInput').value='';
        //document.getElementById('TagInput').value= '';
        $("#TagInput").val('')  
        document.getElementById('HeightInput').value= 0; 
        
    }
    $('input[id=newTodo]').click(function (){
        console.log("new")
        document.getElementById('idInput').value= idMax ;
        document.getElementById('TimeInput').value=formatDate(new Date().getTime());
        $("#TagInput").val('work')  
        document.getElementById('HeightInput').value= 0; 
        //$('input[name=Id]').value = 5
        //$('input[id=TimeInput]').value = formatDate(new Date().getTime())
        //$('input[id=TagInput]').value = 'work'
       // $('input[id=HeightInput]').value = 0
    })
    $('input[id=popTodo]').click(function (){
        var id = document.getElementById('idInput').value
        if ( id >0) {
            for (var i=0;i<gDat.length;i++){
                if (gDat[i].Id == id){
                    console.log(gDat[i])
                    document.getElementById('NameInput').value= gDat[i].Name ;
                    document.getElementById('TimeInput').value = gDat[i].Datetime;
                    $("#TagInput").val(gDat[i].Tag)  
                    document.getElementById('HeightInput').value= parseInt(gDat[i].Height); 
                    console.log("pop")
                    break;
                }
            }
        }else{
            alert("pop error")
            return ;
        }
    })
    
    function showJson(data){
        //var a = JSON.parse(data);
        var gDat = JSON.stringify(data);
        console.log(gDatw)
        //document.getElementById("txt2").innerText= str_pretty1 ;
       // document.getElementById("txt2").rows= data.length ;
    }

    /*  	get请求    */
    function getJson() {
		$.ajax({
			url:'http://localhost:8800/course',
			type:'get',
			dataType:'json',
			success:function (data) {
                gDat = data   
                for(var i=0;i<data.length;i++){
                    idMax= Math.max( parseInt(data[i].Id) +1 ,idMax );            
                }  
                tableDisp(filtDat(gDat))        
			},
			error:function () {
				console.log("get error");
			}
		})
    }
    
	$('input[id=getData]').click(function (){
        console.log("get begin");
        getJson()
    })

    // post请求
    $('input[id=submit]').click(function () {
        var dt = {
                Id: $('input[name=Id]').val(),
                Name: $('input[name=Name]').val(),
                Datetime: $('input[name=Datetime]').val(),
                Tag:  $("#TagInput").val(),// $('input[name=Tag]').val(),
                //tagList[$("#TagInput ").get(0).selectedIndex],
                // $("#TagInput").find("option:selected").text(),
                Height: $('input[name=Height]').val()         
            }
        if (dt.Name=='' || dt.Id== 0){
            alert('input none');
            return;
        }
        console.log('dt=', dt)
        idMax++; 
        $.ajax({
            url: "http://127.0.0.1:8800/create",
            type: 'post',
            data: dt,
            success: function (data) {
                clearInput()
                console.log("post=",data);
                gDat.push(dt)
                tableDisp(filtDat(gDat))
            },
            error:function () {
                console.log("get error");
                idMax--;
			}
        })
    })
    // post to delete请求
    $('input[id=delData]').click(function () {
        $.ajax({
            url: "http://127.0.0.1:8800/delete",
            type: 'post',
            data: {
                name: $('input[type=text]').val()
            },
            success: function (data) {
                console.log(data);                
            }
        })
    })

    function checkHeight(xx) {
            return parseInt(xx.Height) >= 100;
    }
    function checkWork(xx) {
        return xx.Tag == "work";
    }  

    function checkTag(xx) {
        return xx.Tag == $("#tagCombo").val();
    }  
    function checkTime(xx) {
        var tmLst= new Date(xx.Datetime)
        var now = new Date();
        var tmDif = (now - tmLst) /1000;
        return tmDif <= parseInt( $("#timeCombo").val() );
    }  
    function checkHeightMux(xx) {
        var h = $("#heightCombo").val()
        if (h=="0"){
            return xx.Height == 0;
        }else if(h=="99"){
            return xx.Height >=99;
        }else if(h=="1"){
            return xx.Height >0 &&  xx.Height <99;
        }
        return true;
    }  
    function filtDat(data){
        var datFlt=data;
        //console.log( $("#tagCombo").val(),$("#timeCombo").val() ,$("#heightCombo").val()  )
        if ( $("#tagCombo").val()  !="All"){
            datFlt =datFlt.filter(checkTag);
        }
        if ( $("#timeCombo").val()  !="All"){
            datFlt =datFlt.filter(checkTime);
        }
        if ( $("#heightCombo").val()  !="All"){
            datFlt =datFlt.filter(checkHeightMux);
        }
        return datFlt
    }
    $('input[id=filtTime]').click(function () {
        var datFlt=filtDat(gDat);
        tableDisp(datFlt);
    })

    function tableDisp(data){
        var table=document.getElementById("tabProduct");
        table.deleteTFoot()
        for(var i=table.rows.length-1;i>0;i--){
            table.deleteRow( i)
        }
        for(var i=0;i<data.length;i++){
            var row=table.insertRow(table.rows.length);
            var c1=row.insertCell(0);
            c1.innerHTML=data[i].Id;
            console.log( data[i].Id ,data[i].Tag)
            // data[i].setAttribute("EditState", "true"); 
            // <td width="32" align="center" bgcolor="#EFEFEF" Name="Id"><input type="checkbox" name="checkbox" value="checkbox" /></td>  
            c1.innerHTML="<input type='checkbox' name='checkbox22' value='checkbox'>"
            c1.align = "<td align='center' bgcolor='#FFFFFF'>"
            var c2=row.insertCell(1);
            c2.innerHTML=data[i].Id;            
            var c3=row.insertCell(2);
            c3.innerHTML=data[i].Name;
            var c4=row.insertCell(3);
            c4.innerHTML=data[i].Tag;
            var c5=row.insertCell(4);
            c5.innerHTML=data[i].Datetime;
            var c5=row.insertCell(5);
            c5.innerHTML=data[i].Height;
            // SetRowCanEdit(row)  
        }
    }
    
    window.onload=function(){ 
        getJson()
    }
</script>

<style type="text/css">  
    
        body,div,p,ul,li,font,span,td,th{  
            font-size:10pt;  
            line-height:155%;  
        }  
        table{  
            border-top-width: 1px;  
            border-right-width: 1px;  
            border-bottom-width: 0px;  
            border-left-width: 1px;  
            border-top-style: solid;  
            border-right-style: solid;  
            border-bottom-style: none;  
            border-left-style: solid;  
            border-top-color: #CCCCCC;  
            border-right-color: #CCCCCC;  
            border-bottom-color: #CCCCCC;  
            border-left-color: #CCCCCC;  
        }  
        td{  
            border-bottom-width: 1px;  
            border-bottom-style: solid;  
            border-bottom-color: #CCCCCC;  
        }  
        .EditCell_TextBox {  
            width: 90%;  
            border:1px solid #0099CC;  
        }  
        .EditCell_DropDownList {  
            width: 90%;  
        }  
        <!-- -->  
    </style>  
</body>
</html>